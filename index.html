<html>
<head>
<script src='http://code.jquery.com/jquery-2.2.0.min.js'></script>
<script src='https://cdn.socket.io/socket.io-1.4.5.js'></script>
<script src='/public/js/js.cookie.js'></script>
</head>

<body>
<div id="user_data">
  <input type="text" id="user_name"/>
  <button id="update_user_name">Update name</button>
</div>
</body>

<div id="stream">
</div>
<div id="message_box"><input type="text" id="message_content"> <button id="send_message">Send</button></div>
<script>
var socket = io('http://local.deadpool:3000');
var user = '';

socket.on('connect', function (data) {
  console.log('connected successfull');
});

socket.on('message', function(message) {
  console.log(message.username + ': ' + message.data);
  printMessage(message);
});

window.addEventListener("load", function() {

  user = Cookies.get("username")

  if(user) {
    refreshUserData();
  }

  function refreshUserData() {
    $("#user_data").html("<div>Welcome, " + user + "</div>");
  }

  $('#update_user_name').on('click', function(ev) {
    ev.preventDefault();
    user = $('#user_name').val();
    document.cookie = `username=${user}`;
    refreshUserData();
  });

  $('#send_message').on('click', function(data) {
    data.preventDefault();
    var msg = $('#message_content').val();
    console.log(msg.length);
    if(!user || msg == ''){
      return false
    } else {
      if(socket.emit('message', {username: user, data: msg})){
        $("#message_content").val("");
      }
    }
  });
});

function printMessage(message) {
  $("#stream").append(`<div class="message"><div class="username">${message.username}</div><div class="message">${message.data}</div></div>`);
}

</script>
</html>
