<html>
<head>
<script src='http://code.jquery.com/jquery-2.2.0.min.js'></script>
<script src='https://cdn.socket.io/socket.io-1.4.5.js'></script>
<script src='/public/js/js.cookie.js'></script>
<link rel="stylesheet" type="text/css" href="public/chat.css">
</head>

<body>
<div id="user_data">
  <input type="text" id="user_name"/>
  <button id="update_user_name">Update name</button>
</div>
</body>

<div id="chat-box">
            <div class="header">
                Test Room
            </div>
            <div id="messages" class="messages">
            <ul></ul>
          </div>
</div>
<div id="message_box"><input type="text" id="message_content"> <button id="send_message">Send</button></div>
<script>
var socket = io('http://local.deadpool:3000');
var user = '';

socket.on('connect', function (data) {
  console.log('connected successfull');
});

socket.on('message', function(data) {
  console.log(data.username + ': ' + data.message);
  printMessage(data);
  side = (side == 'left') ? 'right' : 'left';
});

socket.on('history', function(data) {
  JSON.parse(data).forEach(function(item) {
    printMessage(item);
  });
});

window.addEventListener("load", function() {

  user = Cookies.get("username")

  if(user) {
    refreshUserData();
  }

  function refreshUserData() {
    $("#user_data").html("<div>Welcome, " + user + "</div>");
  }

  $('#update_user_name').on('click', function(ev) {
    ev.preventDefault();
    user = $('#user_name').val();
    document.cookie = `username=${user}`;
    refreshUserData();
  });

  $('#user_name').keypress(function (e) {
    var key = e.which;
    if(key == 13) {
      user = $('#user_name').val();
      document.cookie = `username=${user}`;
      refreshUserData();
    }
  });

  $('#message_content').keypress(function (e) {
    var key = e.which;
    if(key == 13) {
      sendMessage();
    }
  });

  $('#send_message').on('click', function(data) {
    data.preventDefault();
    sendMessage();
  });

  function sendMessage() {
    var msg = $('#message_content').val();
    if(!user || msg == ''){
      return false
    } else {
      if(socket.emit('message', {user_name: user, data: msg})){
        $("#message_content").val("");
      }
    }
  }

});

function printMessage(data) {
  var date = new Date(data.timestamp );
  var classMessage = (data.username === user) ? 'leftuser' : 'left';
  $("#messages ul").append(`<li><span class=${classMessage}><p><b>${data.username}</b></p><p>${data.message}</p><p>${date.toGMTString()}</p></span></li>`);
}

</script>
</html>
