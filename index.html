<html>
<head>
  <!-- Javascripts -->
  <script src='http://code.jquery.com/jquery-2.2.0.min.js'></script>
  <script src='https://cdn.socket.io/socket.io-1.4.5.js'></script>
  <script src='/public/js/js.cookie.js'></script>

  <!-- CSS -->
  <link rel="stylesheet" type="text/css" href="public/chat.css">

  <!-- Fonts -->
  <link href='https://fonts.googleapis.com/css?family=Poppins:300' rel='stylesheet' type='text/css'>
</head>

<body>
  <div class="header">Test Room</div>
  <div id="user_data">
    <input type="text" id="user_name" placeholder="Please write your username to continue"/>
  </div>
  <div class="user_actions">
    <button id="update_user_name">Set Username</button>
    <button id='logout'>Logout</button>
  <div>

  <div id="chat-box">
    <div id="messages" class="messages">
      <ul></ul>
    </div>
    <div id="message_box"><p></p><input type="text" id="message_content"> <button id="send_message">Send</button></div>
  </div>

</body>

<script>
var socket = io('http://local.deadpool:3000');

socket.on('connect', function (data) {
  console.log('connected successfull');
});

socket.on('message', function(data) {
  printMessage(data);
});

socket.on('history', function(data) {
  JSON.parse(data).forEach(function(item) {
    printMessage(item);
  });
});

window.addEventListener("load", function() {

  refreshUserData();

  function refreshUserData() {
    if(user()) {
      $("#message_box p").html("@" + user());
      $("#user_name").hide();
      $('#update_user_name').hide();
      $('#logout').show();
    } else {
      $("#user_welcome").remove();
      $("#user_name").show();
      $('#logout').hide();
      $('#update_user_name').show();
    }
  }

  $('#update_user_name').on('click', function(ev) {
    ev.preventDefault();
    Cookies.set("username", $('#user_name').val());
    refreshUserData();
  });

  $('#user_name').keypress(function (e) {
    if(e.which === 13) {
      Cookies.set("username",$('#user_name').val());
      refreshUserData();
    }
  });

  $('#logout').on('click', function(e) {
    e.preventDefault();
    Cookies.remove("username");
    refreshUserData();
  });

  $('#message_content').keypress(function (e) {
    var key = e.which;
    if(key === 13) {
      sendMessage();
    }
  });

  $('#send_message').on('click', function(data) {
    data.preventDefault();
    sendMessage();
  });
});

function user() {
  return Cookies.get("username") ? Cookies.get("username") : false;
}

function refreshUserData() {
  $("#user_data").html("<div>Welcome, " + user() + "</div>");
}

function sendMessage() {
    var msg = $('#message_content').val();
    var parentId = $('#chat-box .header').attr('data-thread-id');

    if(!user() || msg === ''){
      return false
    } else {
      var success = socket.emit('message', {
        user_name: user,
        message: msg,
        parent_id: parentId
      });

      if(success){
        $("#message_content").val("");
      }
    }
  }

function printMessage(data) {
  var date = new Date(data.timestamp );
  var classMessage = (data.username === user) ? 'leftuser' : 'left';
  $("#messages ul").append(`<li><span class=${classMessage}><p><b>${data.username}</b></p><p>${data.message}</p><p>${date.toGMTString()}</p></span></li>`);
}

</script>
</html>
